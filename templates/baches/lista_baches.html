{% extends 'base.html' %}

{% block title %}Listado de baches - Pozos Ya{% endblock %}

{% block content %}

<style>
    tr.resaltado {
        background: #fff3b0;
        transition: background 0.6s;
    }
</style>

<h2>Listado de baches reportados</h2>

<div id="map-lista" style="height: 450px; margin-bottom: 20px;"></div>
<form method="get" style="margin-bottom: 12px;">
    <label for="estado">Estado:</label>
    <select name="estado" id="estado">
        <option value="">Todos</option>
        <option value="nuevo" {% if estado_actual == "nuevo" %}selected{% endif %}>Nuevo</option>
        <option value="en_gestion" {% if estado_actual == "en_gestion" %}selected{% endif %}>En gestión</option>
        <option value="resuelto" {% if estado_actual == "resuelto" %}selected{% endif %}>Resuelto</option>
    </select>

    <label for="severidad" style="margin-left: 10px;">Severidad:</label>
    <select name="severidad" id="severidad">
        <option value="">Todas</option>
        <option value="baja" {% if severidad_actual == "baja" %}selected{% endif %}>Baja</option>
        <option value="media" {% if severidad_actual == "media" %}selected{% endif %}>Media</option>
        <option value="alta" {% if severidad_actual == "alta" %}selected{% endif %}>Alta</option>
    </select>

    {% if user.is_authenticated %}
        <label style="margin-left: 10px;">
            <input type="checkbox" name="mios" value="1" {% if mios_actual %}checked{% endif %}>
            Solo mis baches
        </label>
    {% endif %}

    <button type="submit" style="margin-left: 10px;">Filtrar</button>

    <!-- Botón para limpiar filtros -->
    <a href="{% url 'lista_baches' %}" style="margin-left: 8px;">Limpiar</a>
</form>


<!-- Metemos el JSON seguro para JS -->
{{ baches_data|json_script:"baches-data" }}

<script>
    //  Mapa centrado aprox. en Lomas
    const map = L.map('map-lista').setView([-34.76, -58.4], 12);

    // Capa base de OpenStreetMap
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    // Leemos el JSON generado por Django
    const baches = JSON.parse(document.getElementById("baches-data").textContent);

    // Resalta y scrollea a la fila correspondiente en la tabla
    function resaltarFila(id) {
        document.querySelectorAll("tr.resaltado").forEach(tr => tr.classList.remove("resaltado"));

        const row = document.getElementById(`bache-row-${id}`);
        if (row) {
            row.classList.add("resaltado");
            row.scrollIntoView({ behavior: "smooth", block: "center" });
        }
    }

    const markers = [];
    const markersById = {};

    // Por cada bache con coords, agregamos marcador al mapa
    baches.forEach(b => {
        const marker = L.marker([b.latitud, b.longitud]).addTo(map);
        markers.push(marker);

        markersById[b.id] = marker;

        marker.bindPopup(`
            <strong>${b.titulo}</strong><br>
            Severidad: ${b.severidad}<br>
            Estado: ${b.estado}<br>
            ${b.imagen_url ? `<img src="${b.imagen_url}" style="width:140px; margin-top:6px; border-radius:6px;">` : ""}
            <br>
            <a href="/bache/${b.id}/">Ver detalle</a>
        `);

        // Click en marcador → resaltar fila de ese bache en la tabla
        marker.on("click", () => resaltarFila(b.id));
    });

    // Si hay marcadores, ajustamos el mapa para que entren todos!
    if (markers.length > 0) {
        const group = L.featureGroup(markers);
        map.fitBounds(group.getBounds().pad(0.2));
    }

    document.addEventListener("DOMContentLoaded", () => {
        document.querySelectorAll("tr[id^='bache-row-']").forEach(row => {
            row.style.cursor = "pointer";

            row.addEventListener("click", () => {
                const idStr = row.id.replace("bache-row-", "");
                const id = parseInt(idStr);

                const marker = markersById[id];
                if (marker) {
                    map.setView(marker.getLatLng(), 17, { animate: true });
                    marker.openPopup();
                    resaltarFila(id);
                }
            });
        });
    });
    
</script>


<table border="1" cellpadding="5" cellspacing="0">
    <thead>
        <tr>
            <th>Título</th>
            <th>Ubicación</th>
            <th>Barrio</th>
            <th>Severidad</th>
            <th>Estado</th>
            <th>Fecha</th>
            <th>Foto</th>
        </tr>
    </thead>
    <tbody>
    {% for b in baches %}
        <tr id="bache-row-{{ b.id }}">
            <td>
                <a href="{% url 'detalle_bache' b.id %}">{{ b.titulo }}</a>
                {% if user.is_authenticated and b.vecino == user %}
                    (tu reclamo)
                {% endif %}
            </td>
            <td>{{ b.calle }} {{ b.altura }}</td>
            <td>{{ b.barrio }}</td>
            <td>{{ b.get_severidad_display }}</td>
            <td>{{ b.get_estado_display }}</td>
            <td>{{ b.fecha_creacion|date:"d/m/Y H:i" }}</td>
            <td>
                {% if b.imagen %}
                    <img src="{{ b.imagen.url }}" style="width:80px; height:auto; border-radius:4px;">
                {% else %}
                    -
                {% endif %}
            </td>
        </tr>
    {% endfor %}
</tbody>
</table>

{% endblock %}