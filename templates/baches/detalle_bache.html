{% extends "base.html" %}

{% block title %}{{ bache.titulo }} - Pozos Ya{% endblock %}

{% block content %}
<h2>{{ bache.titulo }}</h2>

<p><strong>Ubicación:</strong> {{ bache.calle }} {{ bache.altura }}{% if bache.barrio %}, {{ bache.barrio }}{% endif %}</p>
<p><strong>Severidad:</strong> {{ bache.get_severidad_display }}</p>
<p><strong>Estado:</strong> {{ bache.get_estado_display }}</p>
<p><strong>Reportado por:</strong>
    {% if bache.vecino %}
        {{ bache.vecino.username }}
    {% else %}
        Anónimo
    {% endif %}
</p>
<p><strong>Fecha:</strong> {{ bache.fecha_creacion|date:"d/m/Y H:i" }}</p>

{% if bache.descripcion %}
    <p><strong>Descripción:</strong> {{ bache.descripcion }}</p>
{% endif %}

{% if bache.imagenes.all %}
  <div style="display:flex; gap:10px; flex-wrap:wrap;">
    {% for img in bache.imagenes.all %}
      <img src="{{ img.imagen.url }}" style="width:160px; border-radius:10px;">
    {% endfor %}
  </div>
{% endif %}

{# opcional: si mantenés la imagen legacy #}
{% if bache.imagen %}
  <img src="{{ bache.imagen.url }}" style="width:160px; border-radius:10px;">
{% endif %}
<br>
<hr>

<p><strong>Estado:</strong> {{ bache.get_estado_display }}</p>

{% if bache.fecha_resolucion %}
  <p><strong>Resuelto el:</strong> {{ bache.fecha_resolucion|date:"d/m/Y H:i" }}</p>
{% endif %}

{% if bache.comentario_municipio %}
  <p><strong>Comentario del municipio:</strong> {{ bache.comentario_municipio }}</p>
{% endif %}

<hr>
<h3>Historial de cambios</h3>

{% if historial %}
  <ul style="list-style:none; padding:0; margin:0;">
    {% for h in historial %}
      <li style="margin-bottom:12px; padding:8px; border:1px solid #2e2e2e;">
        <div style="font-size:0.9em; color:#424242;">
          {{ h.fecha|date:"d/m/Y H:i" }}
          {% if h.actor %} | por {{ h.actor.username }} {% endif %}
        </div>

        {% if h.estado_anterior or h.estado_nuevo %}
          <div>
            <strong>Estado</strong>:
            <span style="color:#000000;">{{ h.estado_anterior }}</span>
            →
            <span style="color:#000000;">{{ h.estado_nuevo }}</span>
          </div>
        {% endif %}

        {% if h.comentario_anterior or h.comentario_nuevo %}
          <div style="margin-top:6px;">
            <strong>Comentario</strong>:
            <div style="margin-top:3px;">
              <span style="color:#000000;">{{ h.comentario_anterior|default:"(vacío)" }}</span>
              →
              <span style="color:#000000;">{{ h.comentario_nuevo|default:"(vacío)" }}</span>
            </div>
          </div>
        {% endif %}
      </li>
    {% endfor %}
  </ul>
{% else %}
  <p>No hay cambios registrados todavía.</p>
{% endif %}


<p>
  Me afecta: <strong>{{ bache.upvotes.count }}</strong>
</p>

{% if user.is_authenticated %}
  <form action="{% url 'toggle_upvote' bache.id %}" method="post">
    {% csrf_token %}
    {% if user in bache.upvotes.all %}
      <button type="submit">Quitar voto</button>
    {% else %}
      <button type="submit">Me afecta</button>
    {% endif %}
  </form>
{% else %}
  <p>Iniciá sesión para votar.</p>
{% endif %}

<BR>

<a href="{% url 'lista_baches' %}">Volver al listado</a>
{% endblock %}