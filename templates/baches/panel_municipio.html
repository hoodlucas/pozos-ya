{% extends "base.html" %}
{% load static %}
{% block title %}Panel Municipio{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'baches/css/municipio.css' %}">
{% endblock %}

{% block content %}
<!-- FORM ÚNICO PARA ACTUALIZAR EN MASA (POST) -->
<div class="pm-wrapper">
  <h2 class="pm-title">Panel Municipio</h2>

  <!-- tus filtros / dashboard acá (si querés después lo estilizamos igual) -->
  <!-- FORM DE FILTROS (GET) -->
<form method="get" style="margin-bottom: 15px;">
    <label>Orden:</label>
    <select name="orden">
      <option value="" {% if not orden_actual %}selected{% endif %}>Más nuevos</option>
      <option value="mas_votados" {% if orden_actual == "mas_votados" %}selected{% endif %}>Más votados</option>
      <option value="menos_votados" {% if orden_actual == "menos_votados" %}selected{% endif %}>Menos votados</option>
    </select>
    <label>Estado:</label>
    <select name="estado">
        <option value="">Todos</option>
        {% for val, label in ESTADO_CHOICES %}
            <option value="{{ val }}" {% if val == estado_actual %}selected{% endif %}>
                {{ label }}
            </option>
        {% endfor %}
    </select>

    <label>Severidad:</label>
    <select name="severidad">
        <option value="">Todas</option>
        {% for val, label in SEVERIDAD_CHOICES %}
            <option value="{{ val }}" {% if val == severidad_actual %}selected{% endif %}>
                {{ label }}
            </option>
        {% endfor %}
    </select>

    <label>Barrio:</label>
    <select name="barrio">
        <option value="">Todos</option>
        {% for b in barrios %}
            <option value="{{ b }}" {% if b == barrio_actual %}selected{% endif %}>
                {{ b }}
            </option>
        {% endfor %}
    </select>

    <label>Dirección:</label>
    <input type="text" name="q" placeholder="Buscar título/calle" value="{{ q_actual }}">

    <br> <br>
    <button type="submit">Filtrar</button>
    <a href="{% url 'panel_municipio' %}">Limpiar</a>
</form>

<!-- DASHBOARD -->
<div style="display:flex; gap:12px; margin:10px 0;">
  <div style="padding:8px 12px; border:1px solid #ccc;">
    Total: <strong>{{ total }}</strong>
  </div>
  <div style="padding:8px 12px; border:1px solid #ccc;">
    Nuevos: <strong>{{ nuevos }}</strong>
  </div>
  <div style="padding:8px 12px; border:1px solid #ccc;">
    En gestión: <strong>{{ en_gestion }}</strong>
  </div>
  <div style="padding:8px 12px; border:1px solid #ccc;">
    Resueltos: <strong>{{ resueltos }}</strong>
  </div>
</div>



  <form method="post">
    {% csrf_token %}

    <div class="pm-table-card">
      <div class="pm-table-scroll">
        <table class="pm-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Título</th>
              <th>Ubicación</th>
              <th>Severidad</th>
              <th>Estado</th>
              <th>Fecha creación</th>
              <th>Fecha resolución</th>
              <th>Comentario municipio</th>
              <th>Votos</th>
            </tr>
          </thead>

          <tbody>
            {% for b in baches %}
            <tr>
              <td class="pm-col-id">{{ b.id }}</td>

              <td class="pm-col-title">
                <div class="pm-title-cell">{{ b.titulo }}</div>
              </td>

              <td class="pm-col-ubi">
                <div class="pm-ubi-cell">
                  {{ b.calle }} {{ b.altura }}
                  <span class="pm-muted">({{ b.barrio }})</span>
                </div>
              </td>

              <td>{{ b.get_severidad_display }}</td>

              <td>
                <select class="pm-control pm-select" name="estado_{{ b.id }}">
                  {% for val, label in ESTADO_CHOICES %}
                    <option value="{{ val }}" {% if b.estado == val %}selected{% endif %}>
                      {{ label }}
                    </option>
                  {% endfor %}
                </select>
              </td>

              <td class="pm-nowrap">{{ b.fecha_creacion|date:"d/m/Y H:i" }}</td>

              <td class="pm-nowrap">
                {% if b.fecha_resolucion %}
                  {{ b.fecha_resolucion|date:"d/m/Y H:i" }}
                {% else %}
                  <span class="pm-muted">-</span>
                {% endif %}
              </td>

              <td class="pm-col-comment">
                <textarea class="pm-control pm-textarea" name="comentario_{{ b.id }}" rows="2"
                  placeholder="Comentario del municipio...">{{ b.comentario_municipio }}</textarea>
              </td>

              <td class="pm-col-votes">
                <span class="pm-pill">{{ b.votos_count }}</span>
              </td>
            </tr>
            {% endfor %}
          </tbody>

        </table>
      </div>

      <div class="pm-actions">
        <button type="submit" class="pm-btn pm-btn-primary">Actualizar todos</button>
      </div>
    </div>
  </form>
</div>



<a href="{% url 'exportar_baches_csv' %}?{{ request.GET.urlencode }}">
  Descargar CSV
</a>

{% endblock %}